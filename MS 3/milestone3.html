<!DOCTYPE html>
<html>
<head>
    <title>Chatterbox – Milestone 3</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        #chat { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; }
        .system { color: gray; font-style: italic; }
        #typing { color: green; font-size: 14px; }
    </style>
</head>
<body>

<h2>Chatterbox – Milestone 3 (Rooms + Typing)</h2>

<select id="room">
    <option value="general">General</option>
    <option value="tech">Tech</option>
    <option value="fun">Fun</option>
</select>

<div id="chat"></div>
<div id="typing"></div>

<input id="msg" placeholder="Type message">
<button onclick="sendMessage()">Send</button>

<script>
let username = "";
let room = "";

while (!username) {
    username = prompt("Enter your username:");
    if (username) username = username.trim();
}

while (!room) {
    room = prompt("Enter room name (general / tech / college):");
    if (room) room = room.trim();
}

const chat = document.getElementById("chat");
const typingDiv = document.getElementById("typing");
const msgInput = document.getElementById("msg");

    const socket = new WebSocket("ws://localhost:8000/ws");

    socket.onopen = () => {
        console.log("Connected to server");
        socket.send(JSON.stringify({
            username: username,
            room: room
        }));
    };

    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "chat") {
            addMessage(`${data.username}: ${data.message}`);
        }

        if (data.type === "system") {
            addMessage(data.message, true);
        }

        if (data.type === "typing") {
            typingDiv.innerText = `${data.username} is typing...`;
        }

        if (data.type === "stop_typing") {
            typingDiv.innerText = "";
        }
    };

    function addMessage(text, system=false) {
        const div = document.createElement("div");
        if (system) div.classList.add("system"); 
        div.innerText = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function sendMessage() {
        socket.send(JSON.stringify({
            type: "chat",
            message: msgInput.value
        }));
        msgInput.value = "";
        socket.send(JSON.stringify({ type: "stop_typing" }));
    }

    msgInput.addEventListener("input", () => {
        socket.send(JSON.stringify({ type: "typing" }));
    });
</script>

</body>
</html>