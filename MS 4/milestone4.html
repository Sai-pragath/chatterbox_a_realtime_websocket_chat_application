<!DOCTYPE html>
<html>
<head>
  <title>Chatterbox – Milestone 4</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    #chat { height: 300px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; }
    .system { color: gray; font-style: italic; }
    #typing { color: green; }
  </style>
</head>
<body>

<h2>Chatterbox – Final Version</h2>

<select id="room">
  <option value="general">General</option>
  <option value="tech">Tech</option>
</select>

<div id="chat"></div>
<div id="typing"></div>

<input id="msg" placeholder="Type message">
<button onclick="send()">Send</button>

<script>
let username = "";
let room = "";

// Ask username
while (!username) {
    username = prompt("Enter your username:");
    if (username) username = username.trim();
}

// Ask room
while (!room) {
    room = prompt("Enter room name (general / tech):");
    if (room) room = room.trim();
}

const chat = document.getElementById("chat");
const typingDiv = document.getElementById("typing");
const msg = document.getElementById("msg");
const roomSelect = document.getElementById("room");

roomSelect.value = room;

const ws = new WebSocket("ws://localhost:8000/ws");

ws.onopen = () => {
    ws.send(JSON.stringify({
        username: username,
        room: room
    }));
};

ws.onmessage = (e) => {
    const data = JSON.parse(e.data);

    if (data.type === "chat") {
        add(`${data.username}: ${data.message} (${data.time})`);
    }
    if (data.type === "system") {
        add(data.message, true);
    }
    if (data.type === "typing") {
        typingDiv.innerText = `${data.username} is typing...`;
    }
    if (data.type === "stop_typing") {
        typingDiv.innerText = "";
    }
};

function add(text, system = false) {
    const div = document.createElement("div");
    if (system) div.className = "system";
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function send() {
    if (msg.value.trim() === "") return;
    ws.send(JSON.stringify({ type: "chat", message: msg.value }));
    ws.send(JSON.stringify({ type: "stop_typing" }));
    msg.value = "";
}

msg.addEventListener("input", () => {
    ws.send(JSON.stringify({ type: "typing" }));
});

roomSelect.addEventListener("change", () => {
    const newRoom = roomSelect.value;

    ws.send(JSON.stringify({
        type: "switch_room",
        room: newRoom
    }));

    room = newRoom;
    chat.innerHTML = "";
});
</script>

</body>
</html>